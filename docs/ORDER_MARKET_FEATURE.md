# 🏪 订单市场功能说明

> 买家可以主动浏览和支付订单，无需等待商家分享链接

---

## 📋 功能概述

### 问题
在之前的设计中：
- ❌ 买家必须通过商家分享的支付链接才能看到订单
- ❌ 买家无法主动查看待支付订单
- ❌ 如果链接丢失，买家找不到订单

### 解决方案
**订单市场** - 一个公开的订单浏览页面，买家可以：
- ✅ 查看所有待支付订单
- ✅ 搜索订单号或商家名称
- ✅ 筛选即将过期的订单
- ✅ 直接点击支付

---

## 🎯 功能特性

### 1. 订单列表
- 显示所有 `PENDING` 状态的订单
- 按创建时间倒序排列
- 实时更新订单状态

### 2. 搜索功能
- 支持按订单号搜索
- 支持按商家名称搜索
- 实时过滤结果

### 3. 过滤功能
- **全部订单** - 显示所有待支付订单
- **即将过期** - 显示 1 小时内过期的订单

### 4. 订单信息
每个订单显示：
- 商家名称
- 订单号
- 订单金额
- 支付币种
- 创建时间
- 过期时间
- 订单状态（待支付/即将过期/已过期）

### 5. 快速支付
- 点击"立即支付"按钮
- 跳转到支付页面
- 完成支付流程

---

## 🚀 使用方法

### 方式 1：从首页导航
```
1. 访问 http://localhost:3000
2. 点击导航栏的 "订单市场"
3. 浏览所有待支付订单
```

### 方式 2：从用户页面
```
1. 访问 http://localhost:3000/user
2. 如果没有支付记录，会看到 "浏览订单市场" 按钮
3. 点击按钮跳转到订单市场
```

### 方式 3：直接访问
```
直接访问: http://localhost:3000/orders
```

---

## 📊 页面布局

### 顶部统计卡片
```
┌─────────────────────────────────────────────────────┐
│  📋 待支付订单: 12    ⏰ 即将过期: 3    💰 总金额: $1,234.56  │
└─────────────────────────────────────────────────────┘
```

### 搜索和过滤
```
┌─────────────────────────────────────────────────────┐
│  🔍 [搜索订单号或商家名称...]  [全部] [即将过期]      │
└─────────────────────────────────────────────────────┘
```

### 订单列表
```
┌─────────────────────────────────────────────────────┐
│  Test Store                          ⏰ 即将过期      │
│  订单号: ORDER_001 • 2025-01-15 10:30               │
│  过期时间: 0小时 45分钟                              │
│  ─────────────────────────────────────────────────  │
│  商家: 0x1234...5678              $10.00 USDC       │
│                                    [立即支付]        │
└─────────────────────────────────────────────────────┘
```

---

## 🔄 完整流程

### 场景：买家主动查找订单

```
买家访问订单市场
    ↓
浏览所有待支付订单
    ↓
搜索/筛选订单
    ↓
找到目标订单
    ↓
点击"立即支付"
    ↓
跳转到支付页面
    ↓
连接钱包
    ↓
Approve + Pay
    ↓
支付成功
    ↓
跳转到用户页面
```

---

## 💻 技术实现

### 数据获取
使用合约事件获取订单列表：

```typescript
// 获取 OrderCreated 事件
const logs = await publicClient.getLogs({
  address: CONTRACTS.PAYMENT_GATEWAY_V2,
  event: parseAbiItem('event OrderCreated(...)'),
  fromBlock: BigInt(0),
  toBlock: 'latest',
});

// 为每个订单获取详情
const orderInfo = await publicClient.readContract({
  address: CONTRACTS.PAYMENT_GATEWAY_V2,
  abi: PAYMENT_GATEWAY_ABI,
  functionName: 'getOrder',
  args: [orderId],
});

// 只显示 PENDING 状态的订单
if (status === 0) {
  // 添加到列表
}
```

### 状态过滤
```typescript
// 计算过期时间
const now = Math.floor(Date.now() / 1000);
const timeLeft = order.expiryTime - now;

// 即将过期：1小时内
const isExpiring = timeLeft > 0 && timeLeft < 3600;

// 已过期
const isExpired = timeLeft <= 0;
```

### 搜索功能
```typescript
const filteredOrders = orders.filter((order) => {
  const query = searchQuery.toLowerCase();
  return (
    order.orderId.toLowerCase().includes(query) ||
    order.merchantName.toLowerCase().includes(query)
  );
});
```

---

## 🎨 UI 设计

### 颜色方案
- **待支付** - 蓝色 (Blue)
- **即将过期** - 琥珀色 (Amber)
- **已过期** - 红色 (Red)
- **支付按钮** - 翠绿色 (Emerald)

### 状态标签
```typescript
{isExpiring && (
  <span className="bg-amber-100 text-amber-700">
    ⏰ 即将过期
  </span>
)}

{isExpired && (
  <span className="bg-red-100 text-red-700">
    ❌ 已过期
  </span>
)}
```

### 响应式设计
- 桌面端：3 列统计卡片
- 移动端：1 列堆叠布局
- 搜索栏自适应宽度

---

## 🔐 安全考虑

### 1. 数据验证
- 验证订单状态
- 检查过期时间
- 确认商家地址

### 2. 用户体验
- 已过期订单禁用支付按钮
- 显示清晰的过期提示
- 提供搜索和过滤功能

### 3. 性能优化
- 事件数据缓存
- 分页加载（未来）
- 虚拟滚动（未来）

---

## 📈 未来优化

### 短期（1-2 周）
- [ ] 添加订单分类（按商家、金额、币种）
- [ ] 添加排序功能（金额、时间）
- [ ] 添加收藏功能
- [ ] 添加订单详情预览

### 中期（1 个月）
- [ ] 添加分页加载
- [ ] 添加订单评论/评分
- [ ] 添加商家信誉系统
- [ ] 添加订单推荐算法

### 长期（3 个月）
- [ ] 添加订单聊天功能
- [ ] 添加订单争议解决
- [ ] 添加订单保险
- [ ] 添加订单托管

---

## 🎯 使用场景

### 场景 1：电商平台
```
商家创建商品订单 → 买家浏览订单市场 → 选择商品 → 支付
```

### 场景 2：众筹平台
```
项目方创建众筹订单 → 支持者浏览订单市场 → 选择项目 → 支持
```

### 场景 3：服务预订
```
服务商创建服务订单 → 客户浏览订单市场 → 选择服务 → 预订
```

### 场景 4：捐赠平台
```
公益组织创建捐赠订单 → 捐赠者浏览订单市场 → 选择项目 → 捐赠
```

---

## 🔗 相关页面

### 订单市场页面
- **路径**: `/orders`
- **文件**: `frontend/app/orders/page.tsx`
- **功能**: 浏览所有待支付订单

### 支付页面
- **路径**: `/pay/[orderId]`
- **文件**: `frontend/app/pay/[orderId]/page.tsx`
- **功能**: 完成订单支付

### 用户页面
- **路径**: `/user`
- **文件**: `frontend/app/user/page.tsx`
- **功能**: 查看支付历史和贡献

---

## 📊 数据流

```
OrderCreated 事件
    ↓
订单市场页面
    ↓
getOrder() 获取详情
    ↓
getMerchantInfo() 获取商家
    ↓
显示订单列表
    ↓
买家点击支付
    ↓
跳转到 /pay/[orderId]
    ↓
processPayment()
    ↓
支付成功
    ↓
跳转到 /user
```

---

## 🎉 核心优势

### 1. 用户体验
- ✅ 买家可以主动浏览订单
- ✅ 无需等待商家分享链接
- ✅ 支持搜索和过滤

### 2. 商家价值
- ✅ 增加订单曝光度
- ✅ 提高订单转化率
- ✅ 降低营销成本

### 3. 平台价值
- ✅ 增加用户粘性
- ✅ 提高交易量
- ✅ 构建双边市场

---

## 📚 相关文档

- [快速开始](./QUICK_START.md)
- [支付流程指南](./PAYMENT_FLOW_GUIDE.md)
- [合约代码分析](./PAYMENT_CONTRACT_ANALYSIS.md)
- [用户页面说明](../USER_PAGES_README.md)

---

## 💡 总结

**订单市场功能**让 AetherPay 从"单向支付工具"升级为"双边交易市场"：

- 🏪 **商家**：创建订单，等待买家
- 👤 **买家**：浏览订单，主动支付
- 🌐 **平台**：连接双方，促成交易

这是一个**关键的产品升级**，大大提升了用户体验和平台价值！🚀

